.job_template_deploy: &job_deploy
  type: deploy
  before_script:
  - export DEPLOYS=$(helm --kube-context $KUBE_CONTEXT ls | grep $RELEASE_NAME | wc -l)
  - helm repo add micro-company https://micro-company.github.io/charts/
  - helm repo update
  script:
  - if [ ${DEPLOYS}  -eq 0 ]; then
      helm --kube-context $KUBE_CONTEXT install
        --name $RELEASE_NAME
        --namespace=$CI_PROJECT_NAMESPACE
        --set CI_PROJECT_NAME=$CI_PROJECT_NAME
        --set CI_PIPELINE_ID=$CI_PIPELINE_ID
        --set CI_BUILD_ID=$CI_BUILD_ID
        --set image.tag=$CI_COMMIT_TAG
        --set CI_COMMIT_SHA=$CI_COMMIT_SHA
        micro-company/$RELEASE_NAME;
    else
      helm --kube-context $KUBE_CONTEXT upgrade $RELEASE_NAME micro-company/$RELEASE_NAME
        --namespace=$CI_PROJECT_NAMESPACE
        --set CI_PROJECT_NAME=$CI_PROJECT_NAME
        --set CI_PIPELINE_ID=$CI_PIPELINE_ID
        --set CI_BUILD_ID=$CI_BUILD_ID
        --set image.tag=$CI_COMMIT_TAG
        --set CI_COMMIT_SHA=$CI_COMMIT_SHA;
    fi
  except:
  - branches
